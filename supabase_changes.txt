-- Productos: nuevos campos de precios + stock minimo
alter table public.products
  add column if not exists min_stock numeric default 0 check (min_stock >= 0),
  add column if not exists purchase_price numeric default 0 check (purchase_price >= 0),
  add column if not exists wholesale_price numeric default 0 check (wholesale_price >= 0),
  add column if not exists retail_price numeric default 0 check (retail_price >= 0);

-- Mantener compatibilidad con "precio" si ya existe
update public.products
set retail_price = coalesce(retail_price, precio)
where retail_price is null;

-- Proveedores por sucursal
create table if not exists public.suppliers (
  id bigint generated by default as identity primary key,
  branch_id bigint not null references public.branches(id),
  name text not null,
  phone text,
  email text,
  address text,
  is_active boolean not null default true,
  created_at timestamp with time zone not null default now()
);

create index if not exists suppliers_branch_id_idx
  on public.suppliers(branch_id);

-- Compras/entradas: proveedor + fecha + credito
alter table public.inventory_transactions
  add column if not exists supplier_id bigint references public.suppliers(id),
  add column if not exists purchase_date date,
  add column if not exists is_credit boolean default false;

create index if not exists inventory_transactions_branch_type_date_idx
  on public.inventory_transactions(branch_id, type, created_at);

create index if not exists inventory_transactions_supplier_idx
  on public.inventory_transactions(supplier_id);

-- UOM: asegurar un default de venta/compra por producto
create unique index if not exists product_uoms_default_sale_unique
  on public.product_uoms(product_id)
  where is_default_sale = true;

create unique index if not exists product_uoms_default_purchase_unique
  on public.product_uoms(product_id)
  where is_default_purchase = true;
